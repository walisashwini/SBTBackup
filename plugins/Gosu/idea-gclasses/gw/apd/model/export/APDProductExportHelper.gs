package gw.apd.model.export

uses gw.apd.model.export.xsd.apdproductimport.Import
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Codes_APDDropDownEntry
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Codes_APDDropDownEntry_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Codes_APDDropDownEntry_Description_L10N_ARRAY_APDDropdownEntry_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Codes_APDDropDownEntry_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Codes_APDDropDownEntry_Name_L10N_ARRAY_APDDropdownEntry_Name_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Codes_APDDropDownEntry_Values_APDDropdownValue
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Description_L10N_ARRAY_APDAttribute_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Label_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Label_L10N_ARRAY_APDAttribute_Label_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Rules
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Rules_APDAttributeRule
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Rules_APDDropDownEntryRule
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Attribute_Rules_APDDropDownEntryRule_DropDownEntry
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Description_L10N_ARRAY_APDClause_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Name_L10N_ARRAY_APDClause_Name_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Rules
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Rules_APDClauseRule
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_ScheduledItem
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Terms
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Terms_APDTerm
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn_Name_L10N_ARRAY_APDDropdownColumn_Name_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.CostDefinition_CostCodeFilters
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.CostDefinition_CostCodeFilters_APDCostCodeFilter
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.CostDefinition_CostSteps
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.CostDefinition_CostSteps_APDCostStepDefinition
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ChildrenLabel_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ChildrenLabel_L10N_ARRAY_APDCoverable_ChildrenLabel_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ClauseCategories
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ClauseCategories_APDClauseCategory
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ClauseCategories_APDClauseCategory_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ClauseCategories_APDClauseCategory_Description_L10N_ARRAY_APDClauseCategory_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ClauseCategories_APDClauseCategory_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ClauseCategories_APDClauseCategory_Name_L10N_ARRAY_APDClauseCategory_Name_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCondition
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage_ClaimCategories
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage_ClaimCategories_APDCoverageClaim
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage_CostDefinitions
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage_CostDefinitions_APDCoverageCostDefinition
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage_Perils
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDCoverage_Perils_APDCoveragePeril
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Clauses_APDExclusion
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_CoreFields
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_CoreFields_APDCoreAttribute
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_CostDefinitions
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_CostDefinitions_APDRiskCostDefinition
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Description_L10N_ARRAY_APDCoverable_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ExposureLabel_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_ExposureLabel_L10N_ARRAY_APDCoverable_ExposureLabel_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_Description_L10N_ARRAY_APDExposure_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_Fields
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_Fields_APDExposureField
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_MenuLabel_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_MenuLabel_L10N_ARRAY_APDExposure_MenuLabel_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Exposures_APDExposure_Name_L10N_ARRAY_APDExposure_Name_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Fields
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Fields_APDField
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_MenuLabel_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_MenuLabel_L10N_ARRAY_APDCoverable_MenuLabel_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Coverable_Name_L10N_ARRAY_APDCoverable_Name_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDCoverable
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProduct
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProductLine
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProductToLine
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProduct_Description_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProduct_Description_L10N_ARRAY_APDProduct_Description_L10N
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProduct_Name_L10N_ARRAY
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Import_APDProduct_Name_L10N_ARRAY_APDProduct_Name_L10N
uses entity.APDDropdownValue
uses entity.APDDropdownColumn
uses entity.APDAttribute
uses entity.APDClause
uses entity.APDCoverable
uses entity.APDCostDefinition
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_DefaultCodeValue
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_RuleElements
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_RuleElements_APDRuleElement
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_RuleElements_APDRuleElement_DefaultCodeValue
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_RuleElements_APDRuleElement_RuleConditions
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_RuleElements_APDRuleElement_RuleConditions_APDRuleCondition
uses gw.apd.model.export.xsd.apdproductimport.anonymous.elements.Rule_RuleElements_APDRuleElement_RuleConditions_APDRuleCondition_CodeValue

/**
 * Helper class to populate the 'Import' XmlElement structure
 * Maps the various sub-elements to their complex types
 */
@Export
class APDProductExportHelper {
  var _product : APDProduct
  var _productLines = new HashSet<APDProductLine>()
  var _coverables   = new HashSet<APDCoverable>()

  construct(product : APDProduct){
    _product = product

    for (line in product.ProductLines){
      _productLines.add(line.ProductLine)
      for (child in line.ProductLine.ChildCoverables) {
        _coverables.addAll(findChildren(child))
      }
    }
  }

  static private function findChildren(parent : APDCoverable) : HashSet<APDCoverable> {
    var _children   = new HashSet<APDCoverable>()
    _children.add(parent)
    for (child in parent.ChildCoverables) {
      _children.addAll(findChildren(child))
    }
    return _children
  }

  /**
   * Populate the actual Import complex type
   */
  @Returns("The Import Complex type")
  function buildExport () : Import{
    var product        = buildImportProduct(_product)
    var productLines   = new ArrayList<Import_APDProductLine>()
    var productToLines = new ArrayList<Import_APDProductToLine>()
    var coverables     = new ArrayList<Import_APDCoverable>()

    _product.ProductLines.each(\elt -> {
      productLines.add(buildImportProductLine(elt.ProductLine))
      productToLines.add(buildImportProductToLine(elt))
    })
    _coverables.each(\elt->coverables.add(buildImportCoverable(elt)))

     /*
      * Construct Message
      */
    var export = new Import(){
      :APDProduct       = product,
      :APDProductLine   = productLines,
      :APDProductToLine = productToLines,
      :APDCoverable     = coverables
    }

    return export
  }

  /** ********************************** import XML builders ************************************************************ **/

  private function buildImportProduct(product :APDProduct) :Import_APDProduct{
    return new Import_APDProduct(){
      :PublicId            = product.PublicID,
      :Abbreviation        = product.Abbreviation,
      :CodeIdentifier      = product.CodeIdentifier,
      :Coinsurance         = product.Coinsurance,
      :Currencies          = product.Currencies.Code,
      :DateInstalled       = product.DateInstalled.XmlDateTime,
      :DateUpdated         = product.DateUpdated.XmlDateTime,
      :DefinitionSequence  = product.DefinitionSequence,
      :Description         = product.Description,
      :Description_L10N_ARRAY = buildProductDescriptions(product),
      :Multiline           = product.Multiline,
      :Name                = product.Name,
      :Name_L10N_ARRAY     = buildProductNames(product),
      :ProductAccountType  = product.ProductAccountType.Code,
      :ProductCode         = product.ProductCode,
      :UsesLocationListView = product.UsesLocationListView,
      :WrittenByThirdParty = product.WrittenByThirdParty
    }
  }

  private function buildImportProductLine(productLine: APDProductLine) :Import_APDProductLine {
    return new Import_APDProductLine(){
      :PublicId               = productLine.PublicID,
      :ChildrenLabel          = productLine.ChildrenLabel,
      :ChildrenLabel_L10N_ARRAY = buildCoverableChildrenLabels(productLine),
      :ClauseCategories       = buildClauseCategories(productLine.ClauseCategories),
      :Clauses                = buildClauses(productLine.Clauses),
      :CoreFields             = buildCoreFields(productLine.CoreFields),
      :CostDefinitions        = buildCoverableCostDefinitions(productLine),
      :CoverableType          = productLine.CoverableType.Code,
      :Description            = productLine.Description,
      :Description_L10N_ARRAY = buildCoverableDescriptions(productLine),
      :ExposureLabel          = productLine.ExposureLabel,
      :ExposureLabel_L10N_ARRAY = buildCoverableExposureLabels(productLine),
      :Exposures              = buildExposures(productLine.Exposures),
      :Fields                 = buildFields(productLine.Fields),
      :HasChildren            = productLine.HasChildren,
      :HasExposure            = productLine.HasExposure,
      :MenuLabel              = productLine.MenuLabel,
      :MenuLabel_L10N_ARRAY   = buildMenuLabelNames(productLine),
      :Name                   = productLine.Name,
      :Name_L10N_ARRAY        = buildCoverableNames(productLine),
      :RiskLocation           = productLine.RiskLocation.Code,
      :SeparateBilling        = productLine.SeparateBilling,
      :SeparateCollection     = productLine.SeparateCollection,
      :TypeName               = productLine.TypeName,
      :WrittenByThirdParty    = productLine.WrittenByThirdParty,

      :CodeIdentifier         = productLine.CodeIdentifier,
      :Currencies             = productLine.Currencies.Code,
      :DefinitionSequence     = productLine.DefinitionSequence,
      :LinePrefix             = productLine.LinePrefix,
      :ProductLineCode        = productLine.ProductLineCode
    }
  }

  private function buildImportCoverable(coverable :APDCoverable) :Import_APDCoverable {
    return new Import_APDCoverable(){
      :PublicId         = coverable.PublicID,
      :ChildrenLabel    = coverable.ChildrenLabel,
      :ChildrenLabel_L10N_ARRAY = buildCoverableChildrenLabels(coverable),
      :ClauseCategories = buildClauseCategories(coverable.ClauseCategories),
      :Clauses          = buildClauses(coverable.Clauses),
      :CoreFields       = buildCoreFields(coverable.CoreFields),
      :CostDefinitions  = buildCoverableCostDefinitions(coverable),
      :CoverableType    = coverable.CoverableType.Code,
      :Description      = coverable.Description,
      :Description_L10N_ARRAY = buildCoverableDescriptions(coverable),
      :ExposureLabel    = coverable.ExposureLabel,
      :ExposureLabel_L10N_ARRAY = buildCoverableExposureLabels(coverable),
      :Exposures = buildExposures(coverable.Exposures),
      :Fields           = buildFields(coverable.Fields),
      :HasChildren      = coverable.HasChildren,
      :HasExposure      = coverable.HasExposure,
      :HasModifiers     = coverable.HasModifiers,
      :IsAutoNumbered   = coverable.IsAutoNumbered,
      :MenuLabel        = coverable.MenuLabel,
      :MenuLabel_L10N_ARRAY = buildMenuLabelNames(coverable),
      :Name             = coverable.Name,
      :Name_L10N_ARRAY  = buildCoverableNames(coverable),
      :Parent           = new(){:PublicId=coverable.Parent.PublicID},
      :RiskLocation     = coverable.RiskLocation.Code,
      :SeparateBilling  = coverable.SeparateBilling,
      :SeparateCollection = coverable.SeparateCollection,
      :TypeName         = coverable.TypeName,
      :WrittenByThirdParty = coverable.WrittenByThirdParty
    }
  }

  private function buildImportProductToLine(productToLine :APDProductToLine) : Import_APDProductToLine{
    return new Import_APDProductToLine(){
      :PublicId    = productToLine.PublicID,
      :Product     = new() {:PublicId  = productToLine.Product.PublicID},
      :ProductLine = new() {:PublicId = productToLine.ProductLine.PublicID}
    }
  }

  /** ********************************** element builders ************************************************************ **/

  private function buildProductDescriptions(product :APDProduct) : Import_APDProduct_Description_L10N_ARRAY {
    final var local = new Import_APDProduct_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = product["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Import_APDProduct_Description_L10N_ARRAY_APDProduct_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = product.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildProductNames(product :APDProduct) : Import_APDProduct_Name_L10N_ARRAY {
    final var local = new Import_APDProduct_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = product["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Import_APDProduct_Name_L10N_ARRAY_APDProduct_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = product.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildCoverableChildrenLabels(coverable :APDCoverable) : Coverable_ChildrenLabel_L10N_ARRAY {
    final var local = new Coverable_ChildrenLabel_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = coverable["ChildrenLabel_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_ChildrenLabel_L10N_ARRAY_APDCoverable_ChildrenLabel_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = coverable.PublicID},
          :Value = localValue
        })
      }
    })

    return local
  }

  private function buildCoverableDescriptions(coverable :APDCoverable) : Coverable_Description_L10N_ARRAY {
    final var local = new Coverable_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = coverable["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_Description_L10N_ARRAY_APDCoverable_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = coverable.PublicID},
          :Value = localValue
        })
      }
    })

    return local
  }

  private function buildCoverableExposureLabels(coverable :APDCoverable) : Coverable_ExposureLabel_L10N_ARRAY {
    final var local = new Coverable_ExposureLabel_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = coverable["ExposureLabel_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_ExposureLabel_L10N_ARRAY_APDCoverable_ExposureLabel_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = coverable.PublicID},
          :Value = localValue
        })
      }
    })

    return local
  }

  private function buildMenuLabelNames(coverable :APDCoverable) : Coverable_MenuLabel_L10N_ARRAY {
    final var local = new Coverable_MenuLabel_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = coverable["MenuLabel_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_MenuLabel_L10N_ARRAY_APDCoverable_MenuLabel_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = coverable.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildCoverableNames(coverable :APDCoverable) : Coverable_Name_L10N_ARRAY {
    final var local = new Coverable_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = coverable["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_Name_L10N_ARRAY_APDCoverable_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = coverable.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  /** ******************** exposures ******************************** **/

  private function buildExposures(exposures :APDExposure[]) :Coverable_Exposures {
    var ret  = new Coverable_Exposures()
    exposures.each(\exposure ->
        ret.addChild(new Coverable_Exposures_APDExposure() {
          :PublicId               = exposure.PublicID,
          :ContactRole            = exposure.ContactRole.Code,
          :Coverable              = new () {:PublicId = exposure.Coverable.PublicID},
          :Description            = exposure.Description,
          :Description_L10N_ARRAY = buildExposureDescriptions(exposure),
          :ExposureType           = exposure.ExposureType.Code,
          :Fields                 = buildExposureFields(exposure.Fields),
          :IsAutoNumbered = exposure.IsAutoNumbered,
          :MenuLabel              = exposure.MenuLabel,
          :MenuLabel_L10N_ARRAY   = buildExposureMenuLabels(exposure),
          :Name                   = exposure.Name,
          :Name_L10N_ARRAY        = buildExposureNames(exposure),
          :RatingType             = exposure.RatingType.Code,
          :RiskLocation           = exposure.RiskLocation.Code,
          :TypeName               = exposure.TypeName
        })
    )
    return ret
  }

  private function buildExposureDescriptions(exposure :APDExposure) : Coverable_Exposures_APDExposure_Description_L10N_ARRAY {
    final var local = new Coverable_Exposures_APDExposure_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = exposure["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_Exposures_APDExposure_Description_L10N_ARRAY_APDExposure_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = exposure.PublicID},
          :Value = localValue
        })
      }
    })

    return local
  }

  private function buildExposureMenuLabels(exposure :APDExposure) : Coverable_Exposures_APDExposure_MenuLabel_L10N_ARRAY {
    final var local = new Coverable_Exposures_APDExposure_MenuLabel_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = exposure["MenuLabel_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_Exposures_APDExposure_MenuLabel_L10N_ARRAY_APDExposure_MenuLabel_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = exposure.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildExposureNames(exposure :APDExposure) : Coverable_Exposures_APDExposure_Name_L10N_ARRAY {
    final var local = new Coverable_Exposures_APDExposure_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = exposure["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_Exposures_APDExposure_Name_L10N_ARRAY_APDExposure_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = exposure.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  /** ******************** clauses ********************************** **/

  private function buildClauseCategories(clauseCatergories :APDClauseCategory[]) :Coverable_ClauseCategories {
    var ret = new Coverable_ClauseCategories()
    clauseCatergories.sortBy(\e -> e.Sequence).each(\clauseCategory ->
        ret.addChild(new Coverable_ClauseCategories_APDClauseCategory() {
          :PublicId = clauseCategory.PublicID,
          :CodeIdentifier = clauseCategory.CodeIdentifier,
          :Coverable = new () {:PublicId = clauseCategory.Coverable.PublicID},
          :Description = clauseCategory.Description,
          :Description_L10N_ARRAY = buildClauseCategoryDescriptions(clauseCategory),
          :Hidden = clauseCategory.Hidden,
          :Itemised = clauseCategory.Itemised,
          :Name = clauseCategory.Name,
          :Name_L10N_ARRAY = buildClauseCategoryNames(clauseCategory),
          :Sequence = clauseCategory.Sequence
        })
    )
    return ret
  }

  private function buildClauseCategoryDescriptions(category : APDClauseCategory) : Coverable_ClauseCategories_APDClauseCategory_Description_L10N_ARRAY {
    final var local = new Coverable_ClauseCategories_APDClauseCategory_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = category["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_ClauseCategories_APDClauseCategory_Description_L10N_ARRAY_APDClauseCategory_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = category.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildClauseCategoryNames(category : APDClauseCategory) : Coverable_ClauseCategories_APDClauseCategory_Name_L10N_ARRAY {
    final var local = new Coverable_ClauseCategories_APDClauseCategory_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = category["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Coverable_ClauseCategories_APDClauseCategory_Name_L10N_ARRAY_APDClauseCategory_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = category.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildClauses(clauses: APDClause[]): Coverable_Clauses{
    var ret = new Coverable_Clauses()
    clauses.whereTypeIs(APDCoverage).sortBy(\e -> e.Sequence).each(\coverage -> ret.addChild(
        new Coverable_Clauses_APDCoverage() {
          :PublicId = coverage.PublicID,
          :ClauseCategory = new () {:PublicId = coverage.ClauseCategory.PublicID},
          :CodeIdentifier = coverage.CodeIdentifier,
          :Description = coverage.Description,
          :Description_L10N_ARRAY = buildClauseDescriptions(coverage),
          :Name = coverage.Name,
          :Name_L10N_ARRAY = buildClauseNames(coverage),
          :Rules            = buildClauseRules(coverage),
          :ScheduledItem = buildScheduledItem(coverage.ScheduledItem),
          :Sequence = coverage.Sequence,
          :Terms = buildTerms(coverage),

          :ClaimCategories = buildCoverageClaimCategories(coverage.ClaimCategories),
          :CostDefinitions = buildCoverageCostDefinitions(coverage.CostDefinitions),
          :Coverable = new () {:PublicId = coverage.Coverable.PublicID},
          :Perils = buildCoveragePerils(coverage.Perils),
          :PricingOrder = coverage.PricingOrder,
          :SeparateBilling = coverage.SeparateBilling,
          :SeparateCollection = coverage.SeparateCollection,
          :WrittenByThirdParty = coverage.WrittenByThirdParty
        }))
    clauses.whereTypeIs(APDCondition).each(\condition -> ret.addChild(
        new Coverable_Clauses_APDCondition(){
          :PublicId        = condition.PublicID,
          :ClauseCategory  = new() {:PublicId = condition.ClauseCategory.PublicID},
          :CodeIdentifier  = condition.CodeIdentifier,
          :Description     = condition.Description,
          :Description_L10N_ARRAY = buildClauseDescriptions(condition),
          :Name            = condition.Name,
          :Name_L10N_ARRAY = buildClauseNames(condition),
          :Rules            = buildClauseRules(condition),
          :ScheduledItem    = buildScheduledItem(condition.ScheduledItem),
          :Sequence        = condition.Sequence,
          :Terms           = buildTerms(condition),

          :Coverable       = new(){:PublicId = condition.Coverable.PublicID}
        }))
    clauses.whereTypeIs(APDExclusion).each(\exclusion -> ret.addChild(
        new Coverable_Clauses_APDExclusion(){
          :PublicId        = exclusion.PublicID,
          :ClauseCategory  = new() {:PublicId = exclusion.ClauseCategory.PublicID},
          :CodeIdentifier  = exclusion.CodeIdentifier,
          :Description     = exclusion.Description,
          :Description_L10N_ARRAY = buildClauseDescriptions(exclusion),
          :Name            = exclusion.Name,
          :Name_L10N_ARRAY = buildClauseNames(exclusion),
          :Rules            = buildClauseRules(exclusion),
          :ScheduledItem    = buildScheduledItem(exclusion.ScheduledItem),
          :Sequence        = exclusion.Sequence,
          :Terms           = buildTerms(exclusion),

          :Coverable       = new(){:PublicId = exclusion.Coverable.PublicID}
        }))

    return ret
  }

  private function buildClauseDescriptions(clause : APDClause) : Clause_Description_L10N_ARRAY {
    final var local = new Clause_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = clause["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Clause_Description_L10N_ARRAY_APDClause_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = clause.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildClauseNames(clause : APDClause) : Clause_Name_L10N_ARRAY {
    final var local = new Clause_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = clause["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Clause_Name_L10N_ARRAY_APDClause_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = clause.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  /** ******************** attributes ********************************** **/

  private function buildCoreFields(fields: APDCoreAttribute[]): Coverable_CoreFields {
    var ret = new Coverable_CoreFields()
    fields.each(\field -> {
      ret.addChild(new Coverable_CoreFields_APDCoreAttribute() {
        :PublicId = field.PublicID,
        :Codes = new () {:APDDropDownEntry = buildDropdownEntries(field.Codes)},
        :Description = field.Description,
        :Description_L10N_ARRAY = buildAttributeDescriptions(field),
        :DoNotRegenerate = field.DoNotRegenerate,
        :DropDownType = field.DropDownType.Code,
        :IsDropDownOwner = field.IsDropDownOwner,
        :Jurisdiction = field.Jurisdiction,
        :Label = field.Label,
        :Label_L10N_ARRAY = buildAttributeLabels(field),
        :Name = field.Name,
        :OwningDropDown = new () {:PublicId = field.OwningDropDown.PublicID},
        :Sequence = field.Sequence,
        :Type = field.Type.Code,
        :Typelist = field.Typelist,

        :Coverable = new () {:PublicId = field.Coverable.PublicID},
        :FieldType = field.FieldType.Code
      })
    })
    return ret
  }

  private function buildFields(fields: APDField[]): Coverable_Fields {
    var ret = new Coverable_Fields()
    fields.sortBy(\e -> e.Sequence).each(\field ->
        ret.addChild(new Coverable_Fields_APDField() {
          :PublicId = field.PublicID,
          :Codes = new () {:APDDropDownEntry = buildDropdownEntries(field.Codes)},
          :Description = field.Description,
          :Description_L10N_ARRAY = buildAttributeDescriptions(field),
          :DoNotRegenerate = field.DoNotRegenerate,
          :DropDownType = field.DropDownType.Code,
          :IsDropDownOwner = field.IsDropDownOwner,
          :Jurisdiction = field.Jurisdiction,
          :Label = field.Label,
          :Label_L10N_ARRAY = buildAttributeLabels(field),
          :Name = field.Name,
          :OwningDropDown = new () {:PublicId = field.OwningDropDown.PublicID},
          :Rules = buildAttributeRules(field),
          :Scalable = field.Scalable,
          :Sequence = field.Sequence,
          :SplitByRatingPeriods = field.SplitByRatingPeriods,
          :Type = field.Type.Code,
          :Typelist = field.Typelist,

          :Coverable = new () {:PublicId = field.Coverable.PublicID},
          :Identifier = field.Identifier
        })
    )
    return ret
  }

  private function buildExposureFields(exposureFields :APDExposureField[]) : Coverable_Exposures_APDExposure_Fields{
    var ret = new Coverable_Exposures_APDExposure_Fields()
    exposureFields.sortBy(\e -> e.Sequence).each(\exposureField ->
        ret.addChild(new Coverable_Exposures_APDExposure_Fields_APDExposureField(){
          :PublicId    = exposureField.PublicID,
          :Codes       = new() {:APDDropDownEntry = buildDropdownEntries(exposureField.Codes)},
          :Description = exposureField.Description,
          :Description_L10N_ARRAY = buildAttributeDescriptions(exposureField),
          :DoNotRegenerate = exposureField.DoNotRegenerate,
          :DropDownType = exposureField.DropDownType.Code,
          :IsDropDownOwner = exposureField.IsDropDownOwner,
          :Jurisdiction = exposureField.Jurisdiction,
          :Label       = exposureField.Label,
          :Label_L10N_ARRAY = buildAttributeLabels(exposureField),
          :Name        = exposureField.Name,
          :OwningDropDown = new () {:PublicId = exposureField.OwningDropDown.PublicID},
          :Rules        = buildAttributeRules(exposureField),
          :Scalable = exposureField.Scalable,
          :Sequence    = exposureField.Sequence,
          :SplitByRatingPeriods = exposureField.SplitByRatingPeriods,
          :Type        = exposureField.Type.Code,
          :Typelist    = exposureField.Typelist,

          :Exposure    = new() {:PublicId = exposureField.Exposure.PublicID},
          :ExposureParty = exposureField.ExposureParty,
          :BasisScalingKey = exposureField.BasisScalingKey
        })
    )
    return ret
  }

  private function buildTerms(coverage :APDClause): Clause_Terms {
    var ret = new Clause_Terms()
    coverage.Terms.sortBy(\e -> e.Sequence).each(\ term ->
        ret.addChild(new Clause_Terms_APDTerm(){
          :PublicId    = term.PublicID,
          :Codes       = new() {:APDDropDownEntry = buildDropdownEntries(term.Codes)},
          :Description = term.Description,
          :Description_L10N_ARRAY = buildAttributeDescriptions(term),
          :DoNotRegenerate = term.DoNotRegenerate,
          :DropDownType = term.DropDownType.Code,
          :IsDropDownOwner = term.IsDropDownOwner,
          :Jurisdiction = term.Jurisdiction,
          :Label       = term.Label,
          :Label_L10N_ARRAY = buildAttributeLabels(term),
          :Name        = term.Name,
          :OwningDropDown = new () {:PublicId = term.OwningDropDown.PublicID},
          :Rules        = buildAttributeRules(term),
          :Scalable = term.Scalable,
          :Sequence    = term.Sequence,
          :SplitByRatingPeriods = term.SplitByRatingPeriods,
          :GenerateAsClauseTerm = term.GenerateAsClauseTerm,
          :Type        = term.Type.Code,
          :Typelist    = term.Typelist,

          :Clause      = new() {:PublicId = term.Clause.PublicID},
          :DropdownColumns = new() {:APDDropdownColumn = buildDropdownColumns(term.DropdownColumns)},
          :ScheduleItemAttribute = term.ScheduleItemAttribute
        })
    )
    return ret
  }

  private function buildAttributeLabels(attribute : APDAttribute) : Attribute_Label_L10N_ARRAY {
    final var local = new Attribute_Label_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = attribute["Label_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Attribute_Label_L10N_ARRAY_APDAttribute_Label_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = attribute.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildAttributeDescriptions(attribute : APDAttribute) : Attribute_Description_L10N_ARRAY {
    final var local = new Attribute_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = attribute["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Attribute_Description_L10N_ARRAY_APDAttribute_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = attribute.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildDropdownColumns(dropdownColumns : APDDropdownColumn[]): List<Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn>{
    var ret = new ArrayList<Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn>()
    dropdownColumns.each(\dropdownColumn ->
        ret.add(new Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn(){
          :PublicId     = dropdownColumn.PublicID,
          :Term         = new (){:PublicId = dropdownColumn.Term.PublicID},
          :Name         = dropdownColumn.Name,
          :Name_L10N_ARRAY = buildDropdownColumnNames(dropdownColumn),
          :Sequence     = dropdownColumn.Sequence,
          :ValueType    = dropdownColumn.ValueType.Code
        }
        )
    )
    return ret
  }

  private function buildDropdownColumnNames(ddc : APDDropdownColumn) : Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn_Name_L10N_ARRAY {
    final var local = new Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = ddc["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Clause_Terms_APDTerm_DropdownColumns_APDDropdownColumn_Name_L10N_ARRAY_APDDropdownColumn_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = ddc.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildDropdownEntries(dropdownEntries :APDDropdownEntry[]): List<Attribute_Codes_APDDropDownEntry>{
    var ret = new ArrayList<Attribute_Codes_APDDropDownEntry>()
    // don't save the code list if it is being taken from an alternatively maintained typelist
    if (dropdownEntries.first().Attribute.TypelistExists and dropdownEntries.first().Attribute.DoNotRegenerate) return ret
    // save the codes
    dropdownEntries.each(\dropdownEntry ->
        ret.add(new Attribute_Codes_APDDropDownEntry(){
          :PublicId    = dropdownEntry.PublicID,
          :Attribute   = new (){:PublicId = dropdownEntry.Attribute.PublicID},
          :Code        = dropdownEntry.Code,
          :Currency    = dropdownEntry.Currency.Code,
          :Description = dropdownEntry.Description,
          :Description_L10N_ARRAY = buildDropdownEntryDescriptions(dropdownEntry),
          :Name        = dropdownEntry.Name,
          :Name_L10N_ARRAY = buildDropdownEntryNames(dropdownEntry),
          :Sequence    = dropdownEntry.Sequence,
          :Values      = new() {:APDDropdownValue = buildDropdownValues(dropdownEntry.Values)}
        })
    )
    return ret
  }

  private function buildDropdownValues(dropdownValues : APDDropdownValue[]): List<Attribute_Codes_APDDropDownEntry_Values_APDDropdownValue>{
    var ret = new ArrayList<Attribute_Codes_APDDropDownEntry_Values_APDDropdownValue>()
    // save the values
    dropdownValues.each(\dropdownValue ->
        ret.add(new Attribute_Codes_APDDropDownEntry_Values_APDDropdownValue(){
          :DecimalValue = dropdownValue.DecimalValue,
          :PublicId     = dropdownValue.PublicID,
          :Dropdown     = new (){:PublicId = dropdownValue.Dropdown.PublicID},
          :DropdownColumn = new (){:PublicId = dropdownValue.DropdownColumn.PublicID},
          :IntegerValue = dropdownValue.IntegerValue
        })
    )
    return ret
  }

  private function buildDropdownEntryDescriptions(entry : APDDropdownEntry) : Attribute_Codes_APDDropDownEntry_Description_L10N_ARRAY {
    final var local = new Attribute_Codes_APDDropDownEntry_Description_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = entry["Description_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Attribute_Codes_APDDropDownEntry_Description_L10N_ARRAY_APDDropdownEntry_Description_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = entry.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  private function buildDropdownEntryNames(entry : APDDropdownEntry) : Attribute_Codes_APDDropDownEntry_Name_L10N_ARRAY {
    final var local = new Attribute_Codes_APDDropDownEntry_Name_L10N_ARRAY()
    gw.api.util.LocaleUtil.getAllLanguages()?.toTypedArray().each(\language -> {
      final var localValue = entry["Name_" + language.Code] as String
      if (localValue != null) {
        local.addChild(new Attribute_Codes_APDDropDownEntry_Name_L10N_ARRAY_APDDropdownEntry_Name_L10N() {
          :Language = language.Code,
          :Owner = new () {:PublicId = entry.PublicID},
          :Value = localValue
        })
      }
    })
    return local
  }

  /** *********************** rule definitions ************************** **/

  private function buildAttributeRules(attribute : APDAttribute) : Attribute_Rules {
    final var rules = new Attribute_Rules()
    attribute.Rules.each(\rule -> {
      if (rule typeis APDAttributeRule && !(rule typeis APDDropdownEntryRule)) {
        var attRule = new Attribute_Rules_APDAttributeRule()

        switch (rule.RuleType) {
          case APDRuleType.TC_DEFAULT :
          case APDRuleType.TC_MIN :
          case APDRuleType.TC_MAX :
            switch (attribute.Type) {
              case APDFieldType.TC_BOOLEAN :
                if (rule.DefaultBitValue != null) attRule.DefaultBitValue = rule.DefaultBitValue
                break
              case APDFieldType.TC_TYPEKEY :
                if (rule.DefaultCodeValue != null) attRule.DefaultCodeValue = buildDefaultCodeValue(rule.DefaultCodeValue)
                break
              case APDFieldType.TC_DATE :
                if (rule.DefaultDateValue != null) attRule.DefaultDateValue = rule.DefaultDateValue.XmlDateTime
                break
              case APDFieldType.TC_MONEY :
              case APDFieldType.TC_BIGDECIMAL :
                if (rule.DefaultDecimalValue != null) attRule.DefaultDecimalValue = rule.DefaultDecimalValue
                break
              case APDFieldType.TC_INTEGER :
                if (rule.DefaultIntegerValue != null) attRule.DefaultIntegerValue = rule.DefaultIntegerValue
                break
              case APDFieldType.TC_VARCHAR :
                if (rule.DefaultStringValue != null) attRule.DefaultStringValue = rule.DefaultStringValue
                break
            }
            break
          case APDRuleType.TC_EXISTENCE :
            attRule.DefaultExistence = rule.DefaultExistence.Code
            break
          case APDRuleType.TC_TAG :
            attRule.DefaultTagValue = rule.DefaultTagValue.Code
            break
        }
        attRule.RuleElements = buildRuleElements(rule)
        attRule.RuleType = rule.RuleType.Code
        attRule.TagType = rule.TagType.Code

        attRule.Attribute = new() {:PublicId = rule.Attribute.PublicID}
        rules.addChild(attRule)
      }
    })

    // Iterate again to add dropdown entries. This can't be done in
    // a single loop because otherwise order of write can't be guaranteed.
    // xsd expects attribute node to come first, followed by a dropdown node.
    attribute.Rules.each(\rule -> {
      if (rule typeis APDDropdownEntryRule) {
        var attRule = new Attribute_Rules_APDDropDownEntryRule(){
          :DefaultExistence = rule.DefaultExistence.Code,
          :DefaultTagValue  = rule.DefaultTagValue.Code,
          :RuleElements     = buildRuleElements(rule),
          :RuleType         = rule.RuleType.Code,
          :TagType          = rule.TagType.Code,

          :Attribute        = new() {:PublicId = rule.Attribute.PublicID},
          :DropDownEntry    = buildDropdownEntryForRule(rule)
        }
        rules.addChild(attRule)

      }
    })

    return rules
  }

  private function buildClauseRules(clause : APDClause) : Clause_Rules {
    final var rules = new Clause_Rules()
    clause.Rules.each(\rule -> {
      rules.addChild(new Clause_Rules_APDClauseRule() {
        :DefaultExistence = rule.DefaultExistence.Code,
        :DefaultTagValue = rule.DefaultTagValue.Code,
        :RuleElements = buildRuleElements(rule),
        :RuleType = rule.RuleType.Code,
        :TagType = rule.TagType.Code,

        :Clause = new () {:PublicId = rule.Clause.PublicID}
      })
    })

    return rules
  }

  private function buildDropdownEntryForRule(rule : APDDropdownEntryRule) : Attribute_Rules_APDDropDownEntryRule_DropDownEntry {
    final var noRegen = rule.Attribute.DoNotRegenerate
    final var dropDown = new Attribute_Rules_APDDropDownEntryRule_DropDownEntry() {
      :PublicId = noRegen ? "" : rule.DropdownEntry.PublicID, // this will be-rebuilt when the product is re-loaded
      :Code     = rule.DropdownEntry.Code,
      :Name     = rule.DropdownEntry.Name
    }

    return dropDown
  }

  private function buildRuleElements(rule : APDRule) : Rule_RuleElements {
    final var elements = new Rule_RuleElements()
    rule.RuleElements.each(\elm -> {
      var ruleElem = new Rule_RuleElements_APDRuleElement() {
        :PublicId         = elm.PublicID
      }
      switch (rule.RuleType) {
        case APDRuleType.TC_DEFAULT :
        case APDRuleType.TC_MIN :
        case APDRuleType.TC_MAX :
          if (rule typeis APDAttributeRule) {
            switch (rule.Attribute.Type) {
              case APDFieldType.TC_BOOLEAN :
                if (elm.DefaultBitValue != null) ruleElem.DefaultBitValue = elm.DefaultBitValue
                break
              case APDFieldType.TC_TYPEKEY :
                if (elm.DefaultCodeValue != null) ruleElem.DefaultCodeValue = buildElementDefaultCodeValue(elm.DefaultCodeValue)
                break
              case APDFieldType.TC_DATE :
                if (elm.DefaultDateValue != null) ruleElem.DefaultDateValue = elm.DefaultDateValue.XmlDateTime
                break
              case APDFieldType.TC_MONEY :
              case APDFieldType.TC_BIGDECIMAL :
                if (elm.DefaultDecimalValue != null) ruleElem.DefaultDecimalValue = elm.DefaultDecimalValue
                break
              case APDFieldType.TC_INTEGER :
                if (elm.DefaultIntegerValue != null) ruleElem.DefaultIntegerValue = elm.DefaultIntegerValue
                break
              case APDFieldType.TC_VARCHAR :
                if (rule.DefaultStringValue != null) ruleElem.DefaultStringValue = rule.DefaultStringValue
                break
            }
          }
          break
        case APDRuleType.TC_EXISTENCE :
          ruleElem.Existence = elm.Existence.Code
          break
        case APDRuleType.TC_TAG :
          ruleElem.DefaultTagValue = elm.DefaultTagValue.Code
          break

      }
      ruleElem.Rule = new() {:PublicId = elm.Rule.PublicID}
      ruleElem.RuleConditions = buildRuleConditions(elm)
      ruleElem.Sequence = elm.Sequence
      elements.addChild(ruleElem)
    })

    return elements
  }

  private function buildRuleConditions(elm : APDRuleElement) : Rule_RuleElements_APDRuleElement_RuleConditions {
    final var conditions = new Rule_RuleElements_APDRuleElement_RuleConditions()
    elm.RuleConditions.each(\rc -> {
      var condition = new Rule_RuleElements_APDRuleElement_RuleConditions_APDRuleCondition(){
        :PublicId         = rc.PublicID,
        :Attribute        = new() {:PublicId = rc.Attribute.PublicID},
        :ConditionValue   = rc.ConditionValue,
        :CodeValue        = buildConditionCodeValue(rc.CodeValue),
        :Operator         = rc.Operator.Code,
        :RuleElement      = new() {:PublicId = rc.RuleElement.PublicID}
      }

      conditions.addChild(condition)
    })

    return conditions
  }

  private function buildDefaultCodeValue(entry : APDDropdownEntry) : Rule_DefaultCodeValue {
    final var codeValue = new Rule_DefaultCodeValue(){
      :PublicId         = entry.PublicID,
      :Code            = entry.Code,
      :Name             = entry.Name
    }
    return codeValue
  }

  private function buildElementDefaultCodeValue(entry : APDDropdownEntry) : Rule_RuleElements_APDRuleElement_DefaultCodeValue {
    final var codeValue = new Rule_RuleElements_APDRuleElement_DefaultCodeValue(){
      :PublicId         = entry.PublicID,
      :Code             = entry.Code,
      :Name             = entry.Name
    }
    return codeValue
  }

  private function buildConditionCodeValue(entry : APDDropdownEntry) : Rule_RuleElements_APDRuleElement_RuleConditions_APDRuleCondition_CodeValue {
    final var codeValue = new Rule_RuleElements_APDRuleElement_RuleConditions_APDRuleCondition_CodeValue(){
      :PublicId = entry.PublicID,
      :Code            = entry.Code,
      :Name             = entry.Name
    }
    return codeValue
  }

  /** ******************** coverage definitions ************************* **/

  private function buildCoveragePerils(perils: APDCoveragePeril[]) : Coverable_Clauses_APDCoverage_Perils {
    var ret = new Coverable_Clauses_APDCoverage_Perils()
    perils.each(\peril ->
        ret.addChild( new Coverable_Clauses_APDCoverage_Perils_APDCoveragePeril(){
          :PublicId             = peril.PublicID,
          :Coverage             = new() {:PublicId = peril.Coverage.PublicID},
          :Deductible           = peril.Deductible,
          :DeductibleAttribute  = new() {:PublicId = peril.DeductibleAttribute.PublicID},
          :LimitAttribute       = new() {:PublicId = peril.LimitAttribute.PublicID},
          :Peril                = new() {:PublicId = peril.Peril.PublicID},
          :PerilLimit           = peril.PerilLimit
        })
    )
    return ret
  }

  private function buildCoverageClaimCategories(claimCategories : APDCoverageClaim[]) :Coverable_Clauses_APDCoverage_ClaimCategories {
    var ret = new Coverable_Clauses_APDCoverage_ClaimCategories()
    claimCategories.each(\coverageClaim ->
        ret.addChild( new Coverable_Clauses_APDCoverage_ClaimCategories_APDCoverageClaim(){
          :PublicId           = coverageClaim.PublicID,
          :ClaimCostCategory  = new() {:PublicId = coverageClaim.ClaimCostCategory.PublicID},
          :Coverage           = new() {:PublicId = coverageClaim.Coverage.PublicID}
        })
    )
    return ret
  }

  /** ******************** cost definitions ******************************* **/

  private function buildCoverableCostDefinitions(coverable : APDCoverable): Coverable_CostDefinitions{
    var costDefinitions = new Coverable_CostDefinitions()

    coverable.CostDefinitions.sortBy(\e -> e.PricingOrder).each(\cd ->
        costDefinitions.addChild(new Coverable_CostDefinitions_APDRiskCostDefinition(){
          :PublicId          = cd.PublicID,
          :Basis             = new(){:PublicId = cd.Basis.PublicID},
          :CostCode          = new(){:PublicId = cd.CostCode.PublicID},
          :CostCodeFilters   = buildCostCodeFilters(cd),
          :CostSteps         = buildCostSteps(cd),
          :CumulativeCostBasis = cd.CumulativeCostBasis,
          :JurisdictionFilter = cd.JurisdictionFilter.Code,
          :PricingOrder      = cd.PricingOrder,
          :RateAmountTypeFilter = cd.RateAmountTypeFilter.Code,
          :RatingScale       = cd.RatingScale.Code,
          :SeparateBilling   = cd.SeparateBilling,
          :SeparateCollection = cd.SeparateCollection,

          :Coverable         = new(){:PublicId = cd.Coverable.PublicID}
        })
    )
    return costDefinitions
  }

  private function buildCoverageCostDefinitions(coverageCostDefinitions: APDCoverageCostDefinition[]) :Coverable_Clauses_APDCoverage_CostDefinitions {
    var ret = new Coverable_Clauses_APDCoverage_CostDefinitions()
    coverageCostDefinitions.each(\cd ->
        ret.addChild( new Coverable_Clauses_APDCoverage_CostDefinitions_APDCoverageCostDefinition(){
          :PublicId          = cd.PublicID,
          :Basis             = new(){:PublicId = cd.Basis.PublicID},
          :CostCode          = new(){:PublicId = cd.CostCode.PublicID},
          :CostCodeFilters   = buildCostCodeFilters(cd),
          :CostingByExposure = cd.CostingByExposure,
          :CostSteps         = buildCostSteps(cd),
          :CumulativeCostBasis = cd.CumulativeCostBasis,
          :JurisdictionFilter = cd.JurisdictionFilter.Code,
          :PricingOrder      = cd.PricingOrder,
          :RateAmountTypeFilter = cd.RateAmountTypeFilter.Code,
          :RatingScale       = cd.RatingScale.Code,
          :SeparateBilling   = cd.SeparateBilling,
          :SeparateCollection = cd.SeparateCollection,

          :Coverage          = new(){:PublicId = cd.Coverage.PublicID}
        })
    )
    return ret
  }

  private function buildCostCodeFilters(costDefinition :APDCostDefinition) : CostDefinition_CostCodeFilters {
    var costCodeFilters = new CostDefinition_CostCodeFilters()

    costDefinition.CostCodeFilters.each(\ccf ->
        costCodeFilters.addChild(new CostDefinition_CostCodeFilters_APDCostCodeFilter(){
          :PublicId        = ccf.PublicID,
          :CostCode        = new(){:PublicId = ccf.CostCode.PublicID},
          :CostDefinition  = new(){:PublicId = ccf.CostDefinition.PublicID}
        })
    )
    return costCodeFilters
  }

  private function buildCostSteps(costDefinition :APDCostDefinition) : CostDefinition_CostSteps {
    var costSteps = new CostDefinition_CostSteps()

    costDefinition.CostSteps.each(\cs ->
        costSteps.addChild(new CostDefinition_CostSteps_APDCostStepDefinition(){
          :PublicId        = cs.PublicID,
          :CostDefinition  = new(){:PublicId = cs.CostDefinition.PublicID},
          :Description     = cs.Description,
          :PrimaryFactor   = new(){:PublicId = cs.PrimaryFactor.PublicID}
        })
    )
    return costSteps
  }

  private function buildScheduledItem(scheduledItem : APDScheduledItem) : Clause_ScheduledItem {
    if (scheduledItem == null) {
      return null
    }
    // the Clause_ScheduledItem type extends Coverable but not all of the Coverable fields are used
    return new Clause_ScheduledItem() {
      :PublicId         = scheduledItem.PublicID,
      :ClauseCategories = new Coverable_ClauseCategories(),   // unused
      :Clauses          = new Coverable_Clauses(),            // unused
      :CostDefinitions  = new Coverable_CostDefinitions(),    // unused
      :CoverableType    = "",                                 // unused
      :Description      = scheduledItem.Description,
      :Description_L10N_ARRAY = buildCoverableDescriptions(scheduledItem),
      :Exposures        = new Coverable_Exposures(),          // unused
      :Fields           = new Coverable_Fields(),             // unused
      :Name             = scheduledItem.Name,
      :Name_L10N_ARRAY  = buildCoverableNames(scheduledItem),
      :RiskLocation     = "",                                 // unused
      :TypeName         = scheduledItem.TypeName
    }
  }
}